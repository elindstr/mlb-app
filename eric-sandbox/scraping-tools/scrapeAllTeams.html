<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" href="data:,"> <!-- killing annoying favicon error -->
    <meta charset="UTF-8" /> <!-- needed to display players names that contain special characters -->
  </head>
<body>

<div id="shortlist"></div>
<div id="list"></div>
<div id="jsonDump"></div>

<script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"></script>
<script>

let team_ids = []
let teams = []
fetchTeamsByYear()

async function fetchTeamsByYear() {
  for (let year = 2024; year > 1875; year--) {  // go in reverse to capture most recent team name: eg Cleveland Guardians
    console.log(year)
    await fetchDataForYear(year);
    await sleep(500);
  }
  await writeJSON()
  $("#shortlist").append(`<p>team_ids = [${team_ids}]</p>`)
}
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// iterate over all years 
function fetchDataForYear (year) {

  urlTeams = `https://lookup-service-prod.mlb.com/json/named.team_all_season.bam?sport_code='mlb'&all_star_sw='N'&sort_order=name_asc&season='${year}'`
  fetch(urlTeams)
  .then(function (response) {
    return response.json()
  })
  .then(function (data) {

    if (data) {
        console.log("data received", year)

        // if there were teams that year
        if (data.team_all_season.queryResults.row) {
          console.log(data.team_all_season.queryResults.row.length, "rows in", year)
          
          // iterate over the rows of teams
          for (let row = 0; row < data.team_all_season.queryResults.row.length; row++) {
            
            // check the team_id
            let team_id = data.team_all_season.queryResults.row[row].team_id
            let name_display_full = data.team_all_season.queryResults.row[row].name_display_full

            // if we haven't read the team_id yet, scrape the team data 
            if (team_ids.includes(team_id) == false) {
              team_ids.push(team_id)
              teams.push(data.team_all_season.queryResults.row[row])

              $("#list").append(`<p>${team_ids.length}. ${name_display_full} (team_id = ${team_id}) (last seen in ${year})</p>`)
            }
          }

        }
        else {
          console.log("no rows", year)
        }
    }
    else {
      console.log("no data received:", year)
    }
  })
  .catch(function (error) {
    console.log(error)
  })
}

function writeJSON() {
  let table = $("<table>")
  teams.forEach((team, index) => {
    let tr = $("<tr>")
    let td1 = $(`<td>${index}</td>`)
    let td2 = $(`<td>${JSON.stringify(team)}</td>`)
    tr.append(td1, td2)
    table.append(tr)
  })
  $("#jsonDump").append(table)
}

</script>
</body>
</html>