<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"></script>
</head>
<body>
    <h2>Export team_id and player_id from API data as list objects</h2>
<button>Go</button>
<div id="team_id"></div>
<div id="player_id"></div>

<script>
  $("button").on("click", fetchPlayers)
  const seasonStart = 2023
  const seasonEnd = 2024
  const proxyUrl = "https://cors-anywhere.herokuapp.com/"
  const targetUrl = "https://lookup-service-prod.mlb.com/json/named.roster_team_alltime.bam?start_season=%272023%27&end_season=%272024%27&team_id=%27111%27"

  async function fetchPlayers() {
      let teams = await getTeams()
      let players = []
      for (let t = 0; t < teams.length; t++) {
          console.log(t+1, "of", teams.length)
          const roster = await getRoster(teams[t].team_id)
          players = players.concat(roster)
          await delay(2000)
      }

      renderTeamList(teams)
      $("#team_id").append("<p>")
      await renderPlayerList(players)
      
  }
  function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms))
  }

  function renderTeamList(teams) {
    const listDiv = $("#team_id");
    listDiv.empty();
    listDiv.append("team_ids = [");
    for (let i = 0; i < teams.length; i++) {
      let team = teams[i];
      if (i === teams.length - 1) {
          listDiv.append(`["${team.name}", ${team.team_id}] ]`);
      } else {
          listDiv.append(`["${team.name}", ${team.team_id}], `);
      }
    }
}

function renderPlayerList(players) {
    const listDiv = $("#player_id");
    listDiv.empty();
    listDiv.append("player_ids = [");
    for (let i = 0; i < players.length; i++) {
        let player = players[i];
        if (i === players.length - 1) {
            listDiv.append(`["${player.name_first_last}", ${player.player_id}, ${player.team_id}] ]`);
        } else {
            listDiv.append(`["${player.name_first_last}", ${player.player_id}, ${player.team_id}], `);
        }
    }
}


  async function getTeams() {
    const urlTeams = `https://lookup-service-prod.mlb.com/json/named.team_all_season.bam?sport_code='mlb'&all_star_sw='N'&sort_order=name_asc&season='${seasonStart}'`

    try {
        const response = await fetch(proxyUrl + urlTeams)
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
        }
        const data = await response.json()
        return data.team_all_season.queryResults.row
    } catch (error) {
        console.error("Error fetching teams:", error)
        return []
    }
  }


  async function getRoster(team_id) {
      const urlRoster = `https://lookup-service-prod.mlb.com/json/named.roster_team_alltime.bam?start_season='${seasonStart}'&end_season='${seasonEnd}'&team_id='${team_id}'`

      try {
          const response = await fetch(proxyUrl + urlRoster)
          const data = await response.json()
          console.log(data)
          return data.roster_team_alltime.queryResults.row
      } catch (error) {
          console.error("Error fetching roster:", error)
          return []
      }
  }
</script>
<!-- <script src="player_ids_list.js"></script> -->
</body>
</html>
