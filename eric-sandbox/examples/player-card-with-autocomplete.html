<!-- This is just an internal page for ourselves to demonstrate some useful methods we could use to build an app that looks up the current MLB games by date and provides stats. Obviously a real app should have better UI and separate style.css and .js script files in their conventional directory locations.  -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" href="data:,"> <!-- killing favicon console error -->
    <meta charset="UTF-8" /> <!-- needed to display players names that contain special characters; not working -->
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

  </head>
<body>

<!-- ---------------------------------------
HTML: Example method to lookup Player Stats with autocomplete search
--------------------------------------- -->
<hr>
<h3>Example method to player data lookup with autocomplete.</h3>

<div class="ui-widget">
  <label for="playerStatsSelector">Player Search: </label>
  <input id="playerStatsSelector">
</div>

<div id="playerStatsDiv"></div>

<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script>
// ---------------------------------------
// JS: Example method to lookup Player Stats.
// ---------------------------------------


// This is the main function. It is call from the autocomplete action (at the very bottom of this script).
async function createPlayerCard (player_id, year) {
  console.log(player_id)

  // get stats
  playerDetails = await getPlayerDetails(player_id)
  primary_position_txt = playerDetails.primary_position_txt
  team_id = playerDetails.team_id
  name_display_first_last = playerDetails.name_display_first_last

  // load media (team_id, player_id)
  teamLogo = await getTeamLogo(team_id)
  playerImage = await getPlayerImage(player_id, name_display_first_last)

  // seasonPositionStats depending on hitter or pitcher
  let seasonPositionStats
  if (primary_position_txt == "P") {
      seasonPositionStats2023 = await getSeasonPitcherStats(player_id, year=2023)
      seasonPositionStats2022 = await getSeasonPitcherStats(player_id, year=2022)
      seasonPositionStats2021 = await getSeasonPitcherStats(player_id, year=2021)
      seasonPositionStats2020 = await getSeasonPitcherStats(player_id, year=2020)
      seasonPositionStats2019 = await getSeasonPitcherStats(player_id, year=2019)
      seasonPositionStats2018 = await getSeasonPitcherStats(player_id, year=2018)
      careerPositionStats = await getCareerPitcherStats(player_id)
  }
  else {
      seasonPositionStats2023 = await getSeasonHitterStats(player_id, year=2023)
      seasonPositionStats2022 = await getSeasonHitterStats(player_id, year=2022)
      seasonPositionStats2021 = await getSeasonHitterStats(player_id, year=2021)
      seasonPositionStats2020 = await getSeasonHitterStats(player_id, year=2020)
      seasonPositionStats2019 = await getSeasonHitterStats(player_id, year=2019)
      seasonPositionStats2018 = await getSeasonHitterStats(player_id, year=2018)
      careerPositionStats = await getCareerHitterStats(player_id)
  }
  console.log(seasonPositionStats)

  // get transactions
  transactions = await getTransactions(player_id, startYear=2010)

  // render
  $("#playerStatsDiv").empty()

  let header = $("<header>")
      .css({"height": "200px",
            "background-image": `url('../../assets/media/fields/${team_id}.jpg')`,
            "background-position": "center",
            "background-size": "cover", 
      })

  let image = $(playerImage).css({
                              "width": "150px",
                              "float": "left", 
                              "border": "1px solid black",
                              "border-radius": "50%",
                              "margin": "10px"
                              })
  let playerName =  $(`<h1>${playerDetails.name_display_first_last}</h1>`)

  let details = $(`<div>
      ${playerDetails.primary_position_txt} |
      ${playerDetails.height_feet}' ${playerDetails.height_inches}" |
      ${playerDetails.weight} lb |
      ${playerDetails.age} |
      ${playerDetails.high_school} </div>`)
  $("#playerStatsDiv").append(header)
  $("#playerStatsDiv").append(image, playerName, details)



  
  $("#playerStatsDiv").append("<hr>")
  $("#playerStatsDiv").append("<h2>Player Details</h2>")
  jsonDump(playerDetails)
  
  $("#playerStatsDiv").append("<hr>")
  $("#playerStatsDiv").append("<h2>2023 Season Stats</h2>")
  jsonDump(seasonPositionStats2023)

  $("#playerStatsDiv").append("<hr>")
  $("#playerStatsDiv").append("<h2>2022 Season Stats</h2>")
  jsonDump(seasonPositionStats2022)

  $("#playerStatsDiv").append("<hr>")
  $("#playerStatsDiv").append("<h2>2021 Season Stats</h2>")
  jsonDump(seasonPositionStats2021)

  $("#playerStatsDiv").append("<hr>")
  $("#playerStatsDiv").append("<h2>2020 Season Stats</h2>")
  jsonDump(seasonPositionStats2020)

  $("#playerStatsDiv").append("<hr>")
  $("#playerStatsDiv").append("<h2>2019 Season Stats</h2>")
  jsonDump(seasonPositionStats2019)

  $("#playerStatsDiv").append("<hr>")
  $("#playerStatsDiv").append("<h2>2018 Season Stats</h2>")
  jsonDump(seasonPositionStats2018)

  $("#playerStatsDiv").append("<hr>")
  $("#playerStatsDiv").append("<h2>Career Stats</h2>")
  jsonDump(careerPositionStats)

  $("#playerStatsDiv").append("<hr>")
  $("#playerStatsDiv").append("<h2>Transaction History (since 2010)</h2>")
  if (transactions) {
    for (r = 0; r < transactions.length; r++) {
      jsonDump(transactions[r])
      $("#playerStatsDiv").append("<hr width='75%'>")
    }
  }
}

// ugly way to display data; just dumping raw json data so we can see what data is available
function jsonDump (data) {
  if (data) {
    console.log(data)
    let table = $("<table>")
    let keys = Object.keys(data)
    for (let i = 0; i < keys.length; i++ ) {
        let tr = $("<tr>")
        let td1 = $(`<td>${keys[i]}</td>`)
        let td2 = $(`<td>${data[keys[i]]}</td>`)
        tr.append(td1, td2)
        table.append(tr)
    }
    $("#playerStatsDiv").append(table)
  }
  else {
    console.log("jsonDump: Unable to render")
    $("#playerStatsDiv").append("<p>No data available</p>");
  }
}

// get image files
function getTeamLogo(team_id) {
    let imgsrc = `../../assets/media/team-logos/${team_id}.png`
    let img = $(`<img src="${imgsrc}" width="35px" alt="Image of Team Logo"/>`)
    let imgHTML = img.prop("outerHTML")
    return imgHTML
}
function getPlayerImage(player_id, name_display_first_last) {
    let imgsrc = `../../assets/media/players/${player_id}.jpg`
    let img = $(`<img src="${imgsrc}" width="35px" alt="Image of ${name_display_first_last}"/>`)
    let imgHTML = img.prop("outerHTML")
    return imgHTML
}

function getPlayerDetails (player_id) {
    urlPlayer = `https://lookup-service-prod.mlb.com/json/named.player_info.bam?sport_code='mlb'&player_id='${player_id}'`

    return fetch(urlPlayer)
        .then(function (response) {
            return response.json()
        })
        .then(function (data) {
            console.log(data)
            let playerObject = data.player_info.queryResults.row
            if (playerObject.player_id) {
                return playerObject
            }
        })
            .catch(function (error) {
            console.log(error)
        })
}

function getSeasonPitcherStats(player_id, year) {
  urlSeason = `https://lookup-service-prod.mlb.com/json/named.sport_pitching_tm.bam?league_list_id='mlb'&game_type='R'&season='${year}'&player_id='${player_id}'`
  console.log(urlSeason)

  return fetch(urlSeason)
    .then(function (response) {
        return response.json()
    })
    .then(function (data) {
        console.log(data)
        let playerObject = data.sport_pitching_tm.queryResults.row
        if (playerObject) {
            return playerObject
        }
    })
    .catch(function (error) {
        console.log(error)
    })
}

function getSeasonHitterStats(player_id, year) {
  urlSeason = `https://lookup-service-prod.mlb.com/json/named.sport_hitting_tm.bam?league_list_id='mlb'&game_type='R'&season='${year}'&player_id='${player_id}'`

  return fetch(urlSeason)
  .then(function (response) {
    return response.json()
  })
  .then(function (data) {
    console.log(data)
    let playerObject = data.sport_hitting_tm.queryResults.row
    
    if (playerObject) {
        return playerObject
    }
  })
  .catch(function (error) {
    console.log(error)
  })
}

function getCareerPitcherStats(player_id, year) {
  urlSeason = `https://lookup-service-prod.mlb.com/json/named.sport_career_pitching.bam?league_list_id='mlb'&game_type='R'&player_id='${player_id}'`
  console.log(urlSeason)

  return fetch(urlSeason)
    .then(function (response) {
        return response.json()
    })
    .then(function (data) {
        console.log(data)
        let playerObject = data.sport_career_pitching.queryResults.row
        if (playerObject) {
            return playerObject
        }
    })
    .catch(function (error) {
        console.log(error)
    })
}


function getCareerHitterStats(player_id, year) {
  urlSeason = `https://lookup-service-prod.mlb.com/json/named.sport_career_hitting.bam?league_list_id='mlb'&game_type='R'&player_id='${player_id}'`

  return fetch(urlSeason)
  .then(function (response) {
    return response.json()
  })
  .then(function (data) {
    console.log(data)
    let playerObject = data.sport_career_hitting.queryResults.row
    
    if (playerObject) {
        return playerObject
    }
  })
  .catch(function (error) {
    console.log(error)
  })
}

function getTransactions(player_id, startYear) {
  url = `https://lookup-service-prod.mlb.com/json/named.transaction_all.bam?sport_code='mlb'&start_date='${startYear}0101'&end_date='20241231'&player_id=${player_id}`
  
  return fetch(url)
  .then(function (response) {
    return response.json()
  })
  .then(function (data) {
    console.log(data)
    
    if (data.transaction_all.queryResults.row) {
        return data.transaction_all.queryResults.row
    }
  })
  .catch(function (error) {
    console.log(error)
  })
}

</script>
<!-- ---------------------------------------
JS: Example method for autocomplete lookup
--------------------------------------- -->
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script src="player_id_list_with_teams.js"></script>
<script>
  $( function() {
    let playerNames = player_ids.map(function(item) {
        return {
            label: `${item[0]} (${item[2]})`, // display: ':player name (:team)'
            value: item[1]  // TODO: This is messing up the label display when selected. Is there a way to set the player_id as a data-value, so that it doesn't mess up the display label? And then when it is selected later, to use the data-value instead of the actual value to trigger the createPlayerCard()?

        };
    });
    $( "#playerStatsSelector" ).autocomplete({
      source: playerNames,
      minLength: 2,
      select: function(event, ui) {
          event.preventDefault();
          $(this).val(ui.item.label); // restore label to text
          //console.log(ui.item.label, ui.item.value)
          createPlayerCard(ui.item.value, 2023)
      }
    });
  } );
</script>

</head>
<body>
 
