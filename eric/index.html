<!-- This is just an internal page for ourselves to demonstrate some useful methods we could use to build an app that looks up the current MLB games by date and provides stats. Obviously a real app should have better UI and separate style.css and .js script files in their conventional directory locations.  -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

  </head>
  <style>
    main {
        margin: 5px auto;
        height: 100%;
    }
    aside {
      height: 100%;
      width: 30%;  
      min-width: 220px;
      background-color: rgb(10, 10, 88);
      color: rgb(255, 211, 92);
      padding: 10px;
    }
    .form-floating {
      color: black;
    }
    main {
        width: 65%
    }
  </style>
<body>

<div class="container-fluid text-center">
  <div class="row">
    
    <aside class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
      <h1>SwingStats</h1>
        <div class="form-floating" >
          <input type="text" class="form-control ui-widget"  placeholder="search" id="searchQuery">
          <label for="searchQuery">Search</label>
        </div>
    </aside>

    <main class="main-search col-lg-8 col-md-8 col-sm-8">
      <div id="mainDiv"></div>
    </main>

  </div>
</div>



<!-- Scripts -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>


<!-- ---------------------------------------
JS: Example method for autocomplete lookup
--------------------------------------- -->
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script src="auto-ids.js"></script>
<script>
  $( function() {
    let autoItems = autoIds.map(function(item) {
      if (item[2]) {    
        return {
            
              label: `${item[0]} (${item[2]})`, // display: ':player name (:team)'
              value: item[1]  // TODO: This is messing up the label display when selected. Is there a way to set the player_id as a data-value, so that it doesn't mess up the display label? And then when it is selected later, to use the data-value instead of the actual value to trigger the createPlayerCard()?
            }
        }
        else {
          return {
            label: `${item[0]}`, // display: ':player name (:team)'
            value: item[1]
          }
        }
    });

    $( "#searchQuery" ).autocomplete({
      source: autoItems,
      minLength: 2,
      select: function(event, ui) {
          event.preventDefault();
          $(this).val(ui.item.label); // restore label to text
          //console.log(ui.item.label, ui.item.value)
          createMain(ui.item.value)
      }
    });
  } );
</script>


<!-- ---------------------------------------
  // General Script
  // --------------------------------------- -->
<script>
function createMain(autoID) {
  if (parseInt(autoID) > 1000) {
    createPlayerPage (autoID, 2023)
  }
  else {
    createTeamPage(autoID, 2023)
  }
}


// <!-- ---------------------------------------
// JS: Create Player Page
// --------------------------------------- -->
async function createPlayerPage (player_id, year) {
  console.log(player_id)

  // get stats
  playerDetails = await getPlayerDetails(player_id)
  primary_position_txt = playerDetails.primary_position_txt
  team_id = playerDetails.team_id
  name_display_first_last = playerDetails.name_display_first_last

  // load media (team_id, player_id)
  teamLogo = await getTeamLogo(team_id)
  playerImage = await getPlayerImage(player_id, name_display_first_last)

  // seasonPositionStats depending on hitter or pitcher
  let seasonPositionStats
  if (primary_position_txt == "P") {
      seasonPositionStats2023 = await getSeasonPitcherStats(player_id, year=2023)
      seasonPositionStats2022 = await getSeasonPitcherStats(player_id, year=2022)
      seasonPositionStats2021 = await getSeasonPitcherStats(player_id, year=2021)
      seasonPositionStats2020 = await getSeasonPitcherStats(player_id, year=2020)
      seasonPositionStats2019 = await getSeasonPitcherStats(player_id, year=2019)
      seasonPositionStats2018 = await getSeasonPitcherStats(player_id, year=2018)
      careerPositionStats = await getCareerPitcherStats(player_id)
  }
  else {
      seasonPositionStats2023 = await getSeasonHitterStats(player_id, year=2023)
      seasonPositionStats2022 = await getSeasonHitterStats(player_id, year=2022)
      seasonPositionStats2021 = await getSeasonHitterStats(player_id, year=2021)
      seasonPositionStats2020 = await getSeasonHitterStats(player_id, year=2020)
      seasonPositionStats2019 = await getSeasonHitterStats(player_id, year=2019)
      seasonPositionStats2018 = await getSeasonHitterStats(player_id, year=2018)
      careerPositionStats = await getCareerHitterStats(player_id)
  }
  console.log(seasonPositionStats)

  // get transactions
  transactions = await getTransactions(player_id, startYear=2010)

  // render
  $("#mainDiv").empty()

  let header = $("<header>")
      .css({"height": "200px",
            "background-image": `url('../media/fields/${team_id}.jpg')`,
            "background-position": "center",
            "background-size": "cover", 
      })

  let image = $(playerImage).css({
                              "width": "150px",
                              "float": "left", 
                              "border": "1px solid black",
                              "border-radius": "50%",
                              "margin": "10px"
                              })
  let playerName =  $(`<h1>${playerDetails.name_display_first_last}</h1>`)

  let details = $(`<div>
      ${playerDetails.primary_position_txt} |
      ${playerDetails.height_feet}' ${playerDetails.height_inches}" |
      ${playerDetails.weight} lb |
      ${playerDetails.age} |
      ${playerDetails.high_school} </div>`)
  $("#mainDiv").append(header)
  $("#mainDiv").append(image, playerName, details)



  
  $("#mainDiv").append("<hr>")
  $("#mainDiv").append("<h2>Player Details</h2>")
  jsonDump(playerDetails)
  
  $("#mainDiv").append("<hr>")
  $("#mainDiv").append("<h2>2023 Season Stats</h2>")
  jsonDump(seasonPositionStats2023)

  $("#mainDiv").append("<hr>")
  $("#mainDiv").append("<h2>2022 Season Stats</h2>")
  jsonDump(seasonPositionStats2022)

  $("#mainDiv").append("<hr>")
  $("#mainDiv").append("<h2>2021 Season Stats</h2>")
  jsonDump(seasonPositionStats2021)

  $("#mainDiv").append("<hr>")
  $("#mainDiv").append("<h2>2020 Season Stats</h2>")
  jsonDump(seasonPositionStats2020)

  $("#mainDiv").append("<hr>")
  $("#mainDiv").append("<h2>2019 Season Stats</h2>")
  jsonDump(seasonPositionStats2019)

  $("#mainDiv").append("<hr>")
  $("#mainDiv").append("<h2>2018 Season Stats</h2>")
  jsonDump(seasonPositionStats2018)

  $("#mainDiv").append("<hr>")
  $("#mainDiv").append("<h2>Career Stats</h2>")
  jsonDump(careerPositionStats)

  $("#mainDiv").append("<hr>")
  $("#mainDiv").append("<h2>Transaction History (since 2010)</h2>")
  if (transactions) {
    for (r = 0; r < transactions.length; r++) {
      jsonDump(transactions[r])
      $("#mainDiv").append("<hr width='75%'>")
    }
  }
}

// ugly way to display data; just dumping raw json data so we can see what data is available
function jsonDump (data) {
  if (data) {
    console.log(data)
    let table = $("<table>")
    let keys = Object.keys(data)
    for (let i = 0; i < keys.length; i++ ) {
        let tr = $("<tr>")
        let td1 = $(`<td>${keys[i]}</td>`)
        let td2 = $(`<td>${data[keys[i]]}</td>`)
        tr.append(td1, td2)
        table.append(tr)
    }
    $("#mainDiv").append(table)
  }
  else {
    console.log("jsonDump: Unable to render")
    $("#mainDiv").append("<p>No data available</p>");
  }
}

// get image files
function getTeamLogo(team_id) {
    let imgsrc = `../media/team-logos/${team_id}.png`
    let img = $(`<img src="${imgsrc}" width="35px" alt="Image of Team Logo"/>`)
    let imgHTML = img.prop("outerHTML")
    return imgHTML
}
function getPlayerImage(player_id, name_display_first_last) {
    let imgsrc = `../media/players/${player_id}.jpg`
    let img = $(`<img src="${imgsrc}" width="35px" alt="Image of ${name_display_first_last}"/>`)
    let imgHTML = img.prop("outerHTML")
    return imgHTML
}

function getPlayerDetails (player_id) {
    urlPlayer = `https://lookup-service-prod.mlb.com/json/named.player_info.bam?sport_code='mlb'&player_id='${player_id}'`

    return fetch(urlPlayer)
        .then(function (response) {
            return response.json()
        })
        .then(function (data) {
            console.log(data)
            let playerObject = data.player_info.queryResults.row
            if (playerObject.player_id) {
                return playerObject
            }
        })
            .catch(function (error) {
            console.log(error)
        })
}

function getSeasonPitcherStats(player_id, year) {
  urlSeason = `https://lookup-service-prod.mlb.com/json/named.sport_pitching_tm.bam?league_list_id='mlb'&game_type='R'&season='${year}'&player_id='${player_id}'`
  console.log(urlSeason)

  return fetch(urlSeason)
    .then(function (response) {
        return response.json()
    })
    .then(function (data) {
        console.log(data)
        let playerObject = data.sport_pitching_tm.queryResults.row
        if (playerObject) {
            return playerObject
        }
    })
    .catch(function (error) {
        console.log(error)
    })
}

function getSeasonHitterStats(player_id, year) {
  urlSeason = `https://lookup-service-prod.mlb.com/json/named.sport_hitting_tm.bam?league_list_id='mlb'&game_type='R'&season='${year}'&player_id='${player_id}'`

  return fetch(urlSeason)
  .then(function (response) {
    return response.json()
  })
  .then(function (data) {
    console.log(data)
    let playerObject = data.sport_hitting_tm.queryResults.row
    
    if (playerObject) {
        return playerObject
    }
  })
  .catch(function (error) {
    console.log(error)
  })
}

function getCareerPitcherStats(player_id, year) {
  urlSeason = `https://lookup-service-prod.mlb.com/json/named.sport_career_pitching.bam?league_list_id='mlb'&game_type='R'&player_id='${player_id}'`
  console.log(urlSeason)

  return fetch(urlSeason)
    .then(function (response) {
        return response.json()
    })
    .then(function (data) {
        console.log(data)
        let playerObject = data.sport_career_pitching.queryResults.row
        if (playerObject) {
            return playerObject
        }
    })
    .catch(function (error) {
        console.log(error)
    })
}


function getCareerHitterStats(player_id, year) {
  urlSeason = `https://lookup-service-prod.mlb.com/json/named.sport_career_hitting.bam?league_list_id='mlb'&game_type='R'&player_id='${player_id}'`

  return fetch(urlSeason)
  .then(function (response) {
    return response.json()
  })
  .then(function (data) {
    console.log(data)
    let playerObject = data.sport_career_hitting.queryResults.row
    
    if (playerObject) {
        return playerObject
    }
  })
  .catch(function (error) {
    console.log(error)
  })
}

function getTransactions(player_id, startYear) {
  url = `https://lookup-service-prod.mlb.com/json/named.transaction_all.bam?sport_code='mlb'&start_date='${startYear}0101'&end_date='20241231'&player_id=${player_id}`
  
  return fetch(url)
  .then(function (response) {
    return response.json()
  })
  .then(function (data) {
    console.log(data)
    
    if (data.transaction_all.queryResults.row) {
        return data.transaction_all.queryResults.row
    }
  })
  .catch(function (error) {
    console.log(error)
  })
}

// <!-- ---------------------------------------
// JS: Create Team Page
// --------------------------------------- -->
let proxyUrl = "https://cors-anywhere.herokuapp.com/"

async function createTeamPage(autoID, year) {

  // get details
  let team_id = autoID
  let teamLogo = await getTeamLogo(team_id)
  let teamGeneral = await getTeamGeneral(team_id)
  let teamSchedule = await getTeamSchedule(team_id)
  let teamRoster = await getTeamRoster(team_id)

  let timeName = await teamGeneral.teams[0].name
  let division = await teamGeneral.teams[0].division.name
  // let teamLeaders = await getTeamLeaders(team_id)

  // render
  $("#mainDiv").empty()

  let header = $("<header>")
      .css({"height": "200px",
            "background-image": `url('../media/fields/${team_id}.jpg')`,
            "background-position": "center",
            "background-size": "cover", 
      })
  $("#mainDiv").append(header)

  let image = $(teamLogo).css({
                              "width": "200px",
                              "float": "left", 
                              "border": "1px solid black",
                              "margin": "10px"
                              })
  let teamName =  $(`<h1>${timeName}</h1>`)

  let details = $(`<div>
      ${division} </div>`)
  
  $("#mainDiv").append(image, teamName, details)
  
  
$("#mainDiv").append("<hr>")
$("#mainDiv").append("<h2>Team General</h2>")
jsonDump(teamGeneral.teams[0])

$("#mainDiv").append("<hr>")
$("#mainDiv").append("<h2>Team Schedule</h2>")

    // iterate through result game dates
    for (let d = 0; d < teamSchedule.dates.length; d++) {
      $("#mainDiv").append(`<h3>Games on ${teamSchedule.dates[d].date}</h3>`)
      
      // iterate through games on that day
      for (let g = 0; g < teamSchedule.dates[d].games.length; g++) {

        // teams playing each other
        let awayTeam = teamSchedule.dates[d].games[g].teams.away.team.name
        let homeTeam = teamSchedule.dates[d].games[g].teams.home.team.name

        // prepare team logo images
        let mlbTeam_ids = [109,144,110,111,112,145,113,114,115,116,117,118,108,119,146,158,142,121,147,133,143,134,135,137,136,138,139,140,141,120,1536,1490,1547,1512,1531,1535,1493,1510,1546,165,185,189,191,128,153,176,197,298,166,209,148,221,168,205,211,151,172,178,184,186,188,192,212,157,174,177,180,200,202,163,126,127,220,213,156,129,196,187,224,161,167,169,193,206,208,210,125,130,152,175,181,198,201,219,222,223,299,297,204,199,124,150,123,132,195,155,173]
        
        let awayTeam_id = teamSchedule.dates[d].games[g].teams.away.team.id
        let awayTeam_imgsrc = `../media/team-logos/${awayTeam_id}.png`
        let awayTeam_img = $("<span><span>") 
        if (mlbTeam_ids.includes(parseInt(awayTeam_id))) {
          awayTeam_img = $(`<img src="${awayTeam_imgsrc}" width="35px" />`)
        } 
        let awayTeam_img_html = awayTeam_img.prop("outerHTML")

        let homeTeam_id = teamSchedule.dates[d].games[g].teams.home.team.id
        let homeTeam_imgsrc = `../media/team-logos/${homeTeam_id}.png`
        let homeTeam_img = $("<span><span>") 
        if (mlbTeam_ids.includes(parseInt(homeTeam_id))) {
          homeTeam_img = $(`<img src="${homeTeam_imgsrc}" width="35px" />`)
        } 
        let homeTeam_img_html = homeTeam_img.prop("outerHTML")

        // render game content to gamesDiv, including the team logo if its an MLB team
        $("#mainDiv").append(`<p>${awayTeam}${awayTeam_img_html} @ ${homeTeam}${homeTeam_img_html}</p>`)

        $("#mainDiv").append(`<button id="${teamSchedule.dates[d].games[g].gamePk}">View Game</button>`)
      }
    }

$("#mainDiv").append("<hr>")
$("#mainDiv").append("<h2>Team Roster</h2>")
jsonDump(teamRoster.roster_team_alltime.queryResults.row)

}

function getTeamGeneral(team_id) {
  url = `https://statsapi.mlb.com/api/v1/teams/${team_id}`
  return fetch(url)
      .then(function (response) {
        return response.json()
      })
      .then(function (data) {
        console.log(data)
        return data
      })
      .catch(function (error) {
        console.log(error)
      })
}

function getTeamSchedule(team_id) {
  startDate = "2024-01-01"
  endDate = "2024-12-01"
  let url = `https://statsapi.mlb.com/api/v1/schedule/games/?sportId=1&startDate=${startDate}&endDate=${endDate}&teamId=${team_id}`
  return fetch(url)
      .then(function (response) {
        return response.json()
      })
      .then(function (data) {
        console.log(data)
        return data
      })
      .catch(function (error) {
        console.log(error)
      })
}


function getTeamRoster(team_id, season) {
  seasonStart=2023
  seasonEnd=2024
  url = `https://lookup-service-prod.mlb.com/json/named.roster_team_alltime.bam?start_season='${seasonStart}'&end_season='${seasonEnd}'&team_id='${team_id}'`
  return fetch(url)
      .then(function (response) {
        return response.json()
      })
      .then(function (data) {
        console.log(data)
        return data
      })
      .catch(function (error) {
        console.log(error)
      })
}


  // Endpoint: teams_history
  // URL: https://statsapi.mlb.com/api/{ver}/teams/history
  // Required Parameters
  // teamIds

  // "https://statsapi.mlb.com/api/{ver}/schedule"
  // sportId
  // gamePk
  // gamePks

  //URL: https://statsapi.mlb.com/api/{ver}/standings
  //Required Parameters
  //leagueId

  // Endpoint: transactions
  // URL: https://statsapi.mlb.com/api/{ver}/transactions
  // Required Parameters
  // teamId
  // playerId
  // date
  // startDate + endDate

  // // get transactions
  // transactions = await getTransactions(player_id, startYear=2010)

</script>
</body>
</html>